const { join } = require('path')

module.exports.kit = {
  vite: {
    build: {
      rollupOptions: {
        external: ['@serverless/cloud']
      }
    }
  },
  // hydrate the <div id="svelte"> element in src/app.html
  target: '#svelte',
  files: {
    assets: 'src/assets'
  },
  adapter: {
    name: '@serverless/cloud',
    async adapt({ utils }) {
      const dest = join('.svelte-kit', 'output', 'prerendered')

      utils.rimraf(dest)

      await utils.prerender({ dest })

      const svelte = 'svelte'

      utils.rimraf(svelte)
      utils.copy_server_files(svelte)
      utils.copy(join(__dirname, 'shim.js'), join(svelte, 'index.js'))

      const static_ = 'static'

      utils.rimraf(static_)
      utils.copy(dest, static_)
      utils.copy_static_files(static_)
      utils.copy_client_files(static_)
    }
  }
}
