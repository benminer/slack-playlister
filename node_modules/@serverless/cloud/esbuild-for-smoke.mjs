import esbuild from 'esbuild'
import { copyFileSync, mkdirSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'
import { createRequire } from 'module'

const require = createRequire(import.meta.url)

const __dirname = dirname(fileURLToPath(import.meta.url))

const src = require.resolve('lz4-wasm-nodejs/lz4_wasm_nodejs_bg.wasm')
const dst = join(__dirname, 'smoke-dist/src/workers/lz4_wasm_nodejs_bg.wasm')

mkdirSync(dirname(dst), { recursive: true })
copyFileSync(src, dst)

esbuild
  .build({
    entryPoints: ['./src/index.js', './src/models/index.js', './src/workers/hash.js'],
    external: ['electron', 'chokidar', 'fsevents'],
    outdir: 'smoke-dist/src',
    format: 'cjs',
    bundle: true,
    minify: false,
    platform: 'node',
    target: 'node12'
  })
  .catch((err) => {
    console.error(err)
    process.exitCode = -1
  })
